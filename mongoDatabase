import requests 
import re
import time
from dotenv import load_dotenv
import os
from pymongo import MongoClient

# Load environment variables from .env file
load_dotenv()

# Retrieve the API key from environment variables
api_key = os.getenv("API_KEY")

# MongoDB connection URI
mongo_uri = "mongodb://localhost:27017"

# Connect to MongoDB
client = MongoClient(mongo_uri)
db = client.youtube_comments_database  # Use or create a database
comments_collection = db.comments  # Use or create a collection

# Function to extract video ID from YouTube link
def extract_video_id(youtube_link):
    pattern = r'(?:https?://)?(?:www\.)?(?:youtube\.com/(?:[^/]+/.+/.+|(?:v|e(?:mbed)?)|.*[?&]v=)|youtu\.be/)([a-zA-Z0-9_-]{11})'
    match = re.search(pattern, youtube_link)
    return match.group(1) if match else None

# Function to retrieve comments and store them in MongoDB
def get_comments_and_store(video_id):
    url = "https://www.googleapis.com/youtube/v3/commentThreads"
    params = {
        "part": "snippet",
        "videoId": video_id,
        "key": api_key,
        "maxResults": 10,
        "order": "relevance"
    }

    response = requests.get(url, params=params)
    if response.status_code == 200:
        comments_data = response.json().get("items", [])
        for item in comments_data:
            comment_snippet = item["snippet"]["topLevelComment"]["snippet"]
            author = comment_snippet["authorDisplayName"]
            comment = comment_snippet["textDisplay"]
            published_at = comment_snippet["publishedAt"]
            unix_time = int(time.mktime(time.strptime(published_at, "%Y-%m-%dT%H:%M:%SZ")))

            # Prepare the comment document
            comment_doc = {
                "video_id": video_id,
                "author": author,
                "comment": comment,
                "unix_time": unix_time
            }

            # Insert the comment document into MongoDB
            comments_collection.insert_one(comment_doc)
            print(f"Inserted comment by {author} into MongoDB.")

    else:
        print("Error fetching comments:", response.status_code, response.text)

# Function to handle inputted YouTube links and store comments in MongoDB
def save_comments_from_links(youtube_links):
    for link in youtube_links:
        video_id = extract_video_id(link)
        if video_id:
            get_comments_and_store(video_id)
        else:
            print(f"Invalid YouTube link: {link}")

# Main section: get user input for YouTube links
youtube_links_input = input("Enter YouTube links separated by commas: ")
youtube_links = [link.strip() for link in youtube_links_input.split(",")]
save_comments_from_links(youtube_links)

# Close the MongoDB connection
client.close()